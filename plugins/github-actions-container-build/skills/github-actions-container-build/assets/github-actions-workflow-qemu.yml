name: Build multi-arch container images (QEMU)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build (comma-separated)'
        required: false
        default: 'linux/amd64,linux/arm64'

concurrency:
  group: build-images-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: ${{ github.repository_owner }}
  PLATFORMS: linux/amd64,linux/arm64

permissions:
  contents: read
  packages: write

defaults:
  run:
    shell: bash

jobs:
  # ---------- Python + uv ----------
  build-python-uv:
    name: Build python+uv image (QEMU)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Install podman-static for heredoc support
        run: |
          echo "=== Installing podman-static v5.6.2 ==="
          # Why podman-static?
          # - Containerfile uses RUN <<EOT heredoc syntax (requires buildah >= 1.35.0)
          # - Ubuntu 24.04 podman (4.9.3) uses buildah 1.33.7 (too old, no heredoc)

          curl -fsSL -o /tmp/podman-linux-amd64.tar.gz \
            https://github.com/mgoltzsche/podman-static/releases/latest/download/podman-linux-amd64.tar.gz
          cd /tmp && tar -xzf podman-linux-amd64.tar.gz

          # Install binaries to /usr/bin (not /usr/local/bin) to avoid AppArmor issues
          # Ref: https://github.com/mgoltzsche/podman-static#apparmor-profile
          sudo cp -f podman-linux-amd64/usr/local/bin/* /usr/bin/
          sudo cp -r podman-linux-amd64/etc/* /etc/ 2>/dev/null || true

          # Initialize rootless podman
          podman system migrate

          echo "Podman installed to: $(which podman)"
          podman --version

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login "$REGISTRY" \
            -u "${{ github.actor }}" \
            --password-stdin

      # Optional: Login to Docker Hub
      # - name: Login to Docker Hub
      #   run: |
      #     echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login docker.io \
      #       -u "${{ secrets.DOCKERHUB_USERNAME }}" \
      #       --password-stdin

      - name: Build & push python+uv multi-arch image
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_wait_seconds: 10
          exponential_backoff: true
          command: |
            PLATFORMS="${{ github.event.inputs.platforms || env.PLATFORMS }}"
            IMAGE="$REGISTRY/$IMAGE_OWNER/python-uv-app"

            # Build multi-arch manifest
            podman build \
              --platform "$PLATFORMS" \
              --format docker \
              --manifest "$IMAGE:latest" \
              --ulimit nofile=65536:65536 \
              -f ./Containerfile.python-uv \
              .

            # Push to GHCR
            podman manifest push "$IMAGE:latest" "docker://$IMAGE:latest"

            # Optional: Push to Docker Hub
            # podman manifest push "$IMAGE:latest" \
            #   "docker://docker.io/${{ secrets.DOCKERHUB_USERNAME }}/python-uv-app:latest"

  # ---------- Bun ----------
  build-bun:
    name: Build bun image (QEMU)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Install podman-static for heredoc support
        run: |
          echo "=== Installing podman-static v5.6.2 ==="
          # Why podman-static?
          # - Containerfile uses RUN <<EOT heredoc syntax (requires buildah >= 1.35.0)
          # - Ubuntu 24.04 podman (4.9.3) uses buildah 1.33.7 (too old, no heredoc)

          curl -fsSL -o /tmp/podman-linux-amd64.tar.gz \
            https://github.com/mgoltzsche/podman-static/releases/latest/download/podman-linux-amd64.tar.gz
          cd /tmp && tar -xzf podman-linux-amd64.tar.gz

          # Install binaries to /usr/bin (not /usr/local/bin) to avoid AppArmor issues
          # Ref: https://github.com/mgoltzsche/podman-static#apparmor-profile
          sudo cp -f podman-linux-amd64/usr/local/bin/* /usr/bin/
          sudo cp -r podman-linux-amd64/etc/* /etc/ 2>/dev/null || true

          # Initialize rootless podman
          podman system migrate

          echo "Podman installed to: $(which podman)"
          podman --version

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login "$REGISTRY" \
            -u "${{ github.actor }}" \
            --password-stdin

      # Optional: Login to Docker Hub
      # - name: Login to Docker Hub
      #   run: |
      #     echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login docker.io \
      #       -u "${{ secrets.DOCKERHUB_USERNAME }}" \
      #       --password-stdin

      - name: Build & push bun multi-arch image
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_wait_seconds: 10
          exponential_backoff: true
          command: |
            PLATFORMS="${{ github.event.inputs.platforms || env.PLATFORMS }}"
            IMAGE="$REGISTRY/$IMAGE_OWNER/bun-app"

            # Build multi-arch manifest
            podman build \
              --platform "$PLATFORMS" \
              --format docker \
              --manifest "$IMAGE:latest" \
              --ulimit nofile=65536:65536 \
              -f ./Containerfile.bun \
              .

            # Push to GHCR
            podman manifest push "$IMAGE:latest" "docker://$IMAGE:latest"

            # Optional: Push to Docker Hub
            # podman manifest push "$IMAGE:latest" \
            #   "docker://docker.io/${{ secrets.DOCKERHUB_USERNAME }}/bun-app:latest"

  # ---------- Node.js + pnpm ----------
  build-node:
    name: Build node image (QEMU)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Install podman-static for heredoc support
        run: |
          echo "=== Installing podman-static v5.6.2 ==="
          # Why podman-static?
          # - Containerfile uses RUN <<EOT heredoc syntax (requires buildah >= 1.35.0)
          # - Ubuntu 24.04 podman (4.9.3) uses buildah 1.33.7 (too old, no heredoc)

          curl -fsSL -o /tmp/podman-linux-amd64.tar.gz \
            https://github.com/mgoltzsche/podman-static/releases/latest/download/podman-linux-amd64.tar.gz
          cd /tmp && tar -xzf podman-linux-amd64.tar.gz

          # Install binaries to /usr/bin (not /usr/local/bin) to avoid AppArmor issues
          # Ref: https://github.com/mgoltzsche/podman-static#apparmor-profile
          sudo cp -f podman-linux-amd64/usr/local/bin/* /usr/bin/
          sudo cp -r podman-linux-amd64/etc/* /etc/ 2>/dev/null || true

          # Initialize rootless podman
          podman system migrate

          echo "Podman installed to: $(which podman)"
          podman --version

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login "$REGISTRY" \
            -u "${{ github.actor }}" \
            --password-stdin

      # Optional: Login to Docker Hub
      # - name: Login to Docker Hub
      #   run: |
      #     echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login docker.io \
      #       -u "${{ secrets.DOCKERHUB_USERNAME }}" \
      #       --password-stdin

      - name: Build & push node multi-arch image
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_wait_seconds: 10
          exponential_backoff: true
          command: |
            PLATFORMS="${{ github.event.inputs.platforms || env.PLATFORMS }}"
            IMAGE="$REGISTRY/$IMAGE_OWNER/node-app"

            # Build multi-arch manifest
            podman build \
              --platform "$PLATFORMS" \
              --format docker \
              --manifest "$IMAGE:latest" \
              --ulimit nofile=65536:65536 \
              -f ./Containerfile.nodejs \
              .

            # Push to GHCR
            podman manifest push "$IMAGE:latest" "docker://$IMAGE:latest"

            # Optional: Push to Docker Hub
            # podman manifest push "$IMAGE:latest" \
            #   "docker://docker.io/${{ secrets.DOCKERHUB_USERNAME }}/node-app:latest"
