name: Build multi-arch container images

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: build-images-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: ${{ github.repository_owner }}

permissions:
  contents: read
  packages: write

defaults:
  run:
    shell: bash

jobs:
  # ---------- Python + uv ----------
  build-python-uv:
    name: Build python+uv image (${{ matrix.arch }})
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install podman-static for heredoc support
        run: |
          echo "=== Installing podman-static v5.6.2 ==="
          # Why podman-static?
          # - Containerfile uses RUN <<EOT heredoc syntax (requires buildah >= 1.35.0)
          # - Ubuntu 24.04 podman (4.9.3) uses buildah 1.33.7 (too old, no heredoc)

          # Download correct architecture binary
          ARCH="${{ matrix.arch }}"
          if [ "$ARCH" = "amd64" ]; then
            PODMAN_ARCH="amd64"
          else
            PODMAN_ARCH="arm64"
          fi

          curl -fsSL -o /tmp/podman-linux-${PODMAN_ARCH}.tar.gz \
            https://github.com/mgoltzsche/podman-static/releases/latest/download/podman-linux-${PODMAN_ARCH}.tar.gz
          cd /tmp && tar -xzf podman-linux-${PODMAN_ARCH}.tar.gz

          # Install binaries to /usr/bin (not /usr/local/bin) to avoid AppArmor issues
          # Ref: https://github.com/mgoltzsche/podman-static#apparmor-profile
          sudo cp -f podman-linux-${PODMAN_ARCH}/usr/local/bin/* /usr/bin/
          sudo cp -r podman-linux-${PODMAN_ARCH}/etc/* /etc/ 2>/dev/null || true

          # Initialize rootless podman
          podman system migrate

          echo "Podman installed to: $(which podman)"
          podman --version
          echo "Architecture: $(uname -m)"

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login "$REGISTRY" \
            -u "${{ github.actor }}" \
            --password-stdin

      # Optional: Login to Docker Hub
      # - name: Login to Docker Hub
      #   run: |
      #     echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login docker.io \
      #       -u "${{ secrets.DOCKERHUB_USERNAME }}" \
      #       --password-stdin

      - name: Build & push python+uv image
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          exponential_backoff: true
          command: |
            IMAGE="$REGISTRY/$IMAGE_OWNER/python-uv-app"
            TAG="${{ matrix.arch }}"

            # Production build (default, no shell)
            podman build \
              --format docker \
              --ulimit nofile=65536:65536 \
              -f Containerfile.python-uv \
              -t "$IMAGE:$TAG" .

            # Optional: Build debug version with shell
            # podman build \
            #   --build-arg RUNTIME_TAG=latest-dev \
            #   --format docker \
            #   -f Containerfile.python-uv \
            #   -t "$IMAGE:$TAG-debug" .

            # Push to GHCR
            podman push "$IMAGE:$TAG"
            # podman push "$IMAGE:$TAG-debug"

            # Optional: Push to Docker Hub
            # podman push "docker://docker.io/${{ secrets.DOCKERHUB_USERNAME }}/python-uv-app:$TAG"

  manifest-python-uv:
    name: Create python+uv multi-arch manifest
    needs: build-python-uv
    runs-on: ubuntu-24.04
    steps:
      - name: Install podman-static for heredoc support
        run: |
          echo "=== Installing podman-static v5.6.2 ==="
          # Why podman-static?
          # - Containerfile uses RUN <<EOT heredoc syntax (requires buildah >= 1.35.0)
          # - Ubuntu 24.04 podman (4.9.3) uses buildah 1.33.7 (too old, no heredoc)

          # Download correct architecture binary
          ARCH="${{ matrix.arch }}"
          if [ "$ARCH" = "amd64" ]; then
            PODMAN_ARCH="amd64"
          else
            PODMAN_ARCH="arm64"
          fi

          curl -fsSL -o /tmp/podman-linux-${PODMAN_ARCH}.tar.gz \
            https://github.com/mgoltzsche/podman-static/releases/latest/download/podman-linux-${PODMAN_ARCH}.tar.gz
          cd /tmp && tar -xzf podman-linux-${PODMAN_ARCH}.tar.gz

          # Install binaries to /usr/bin (not /usr/local/bin) to avoid AppArmor issues
          # Ref: https://github.com/mgoltzsche/podman-static#apparmor-profile
          sudo cp -f podman-linux-${PODMAN_ARCH}/usr/local/bin/* /usr/bin/
          sudo cp -r podman-linux-${PODMAN_ARCH}/etc/* /etc/ 2>/dev/null || true

          # Initialize rootless podman
          podman system migrate

          echo "Podman installed to: $(which podman)"
          podman --version
          echo "Architecture: $(uname -m)"

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login "$REGISTRY" \
            -u "${{ github.actor }}" \
            --password-stdin

      # Optional: Login to Docker Hub
      # - name: Login to Docker Hub
      #   run: |
      #     echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login docker.io \
      #       -u "${{ secrets.DOCKERHUB_USERNAME }}" \
      #       --password-stdin

      - name: Create & push python+uv manifest
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          exponential_backoff: true
          command: |
            IMAGE="$REGISTRY/$IMAGE_OWNER/python-uv-app"

            podman manifest create "$IMAGE:latest" || true

            podman manifest add "$IMAGE:latest" "docker://$IMAGE:amd64"
            podman manifest add "$IMAGE:latest" "docker://$IMAGE:arm64"

            # Push to GHCR
            podman manifest push --all "$IMAGE:latest"

            # Optional: Push to Docker Hub
            # podman manifest push --all "$IMAGE:latest" \
            #   "docker://docker.io/${{ secrets.DOCKERHUB_USERNAME }}/python-uv-app:latest"

  # ---------- Bun ----------
  build-bun:
    name: Build bun image (${{ matrix.arch }})
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install podman-static for heredoc support
        run: |
          echo "=== Installing podman-static v5.6.2 ==="
          # Why podman-static?
          # - Containerfile uses RUN <<EOT heredoc syntax (requires buildah >= 1.35.0)
          # - Ubuntu 24.04 podman (4.9.3) uses buildah 1.33.7 (too old, no heredoc)

          # Download correct architecture binary
          ARCH="${{ matrix.arch }}"
          if [ "$ARCH" = "amd64" ]; then
            PODMAN_ARCH="amd64"
          else
            PODMAN_ARCH="arm64"
          fi

          curl -fsSL -o /tmp/podman-linux-${PODMAN_ARCH}.tar.gz \
            https://github.com/mgoltzsche/podman-static/releases/latest/download/podman-linux-${PODMAN_ARCH}.tar.gz
          cd /tmp && tar -xzf podman-linux-${PODMAN_ARCH}.tar.gz

          # Install binaries to /usr/bin (not /usr/local/bin) to avoid AppArmor issues
          # Ref: https://github.com/mgoltzsche/podman-static#apparmor-profile
          sudo cp -f podman-linux-${PODMAN_ARCH}/usr/local/bin/* /usr/bin/
          sudo cp -r podman-linux-${PODMAN_ARCH}/etc/* /etc/ 2>/dev/null || true

          # Initialize rootless podman
          podman system migrate

          echo "Podman installed to: $(which podman)"
          podman --version
          echo "Architecture: $(uname -m)"

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login "$REGISTRY" \
            -u "${{ github.actor }}" \
            --password-stdin

      # Optional: Login to Docker Hub
      # - name: Login to Docker Hub
      #   run: |
      #     echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login docker.io \
      #       -u "${{ secrets.DOCKERHUB_USERNAME }}" \
      #       --password-stdin

      - name: Build & push bun image
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          exponential_backoff: true
          command: |
            IMAGE="$REGISTRY/$IMAGE_OWNER/bun-app"
            TAG="${{ matrix.arch }}"

            # Production build (default, no shell)
            podman build \
              --format docker \
              --ulimit nofile=65536:65536 \
              -f Containerfile.bun \
              -t "$IMAGE:$TAG" .

            # Optional: Build debug version with shell
            # podman build \
            #   --build-arg RUNTIME_TAG=latest-dev \
            #   --format docker \
            #   -f Containerfile.bun \
            #   -t "$IMAGE:$TAG-debug" .

            # Push to GHCR
            podman push "$IMAGE:$TAG"
            # podman push "$IMAGE:$TAG-debug"

            # Optional: Push to Docker Hub
            # podman push "docker://docker.io/${{ secrets.DOCKERHUB_USERNAME }}/bun-app:$TAG"

  manifest-bun:
    name: Create bun multi-arch manifest
    needs: build-bun
    runs-on: ubuntu-24.04
    steps:
      - name: Install podman-static for heredoc support
        run: |
          echo "=== Installing podman-static v5.6.2 ==="
          # Why podman-static?
          # - Containerfile uses RUN <<EOT heredoc syntax (requires buildah >= 1.35.0)
          # - Ubuntu 24.04 podman (4.9.3) uses buildah 1.33.7 (too old, no heredoc)

          # Download correct architecture binary
          ARCH="${{ matrix.arch }}"
          if [ "$ARCH" = "amd64" ]; then
            PODMAN_ARCH="amd64"
          else
            PODMAN_ARCH="arm64"
          fi

          curl -fsSL -o /tmp/podman-linux-${PODMAN_ARCH}.tar.gz \
            https://github.com/mgoltzsche/podman-static/releases/latest/download/podman-linux-${PODMAN_ARCH}.tar.gz
          cd /tmp && tar -xzf podman-linux-${PODMAN_ARCH}.tar.gz

          # Install binaries to /usr/bin (not /usr/local/bin) to avoid AppArmor issues
          # Ref: https://github.com/mgoltzsche/podman-static#apparmor-profile
          sudo cp -f podman-linux-${PODMAN_ARCH}/usr/local/bin/* /usr/bin/
          sudo cp -r podman-linux-${PODMAN_ARCH}/etc/* /etc/ 2>/dev/null || true

          # Initialize rootless podman
          podman system migrate

          echo "Podman installed to: $(which podman)"
          podman --version
          echo "Architecture: $(uname -m)"

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login "$REGISTRY" \
            -u "${{ github.actor }}" \
            --password-stdin

      # Optional: Login to Docker Hub
      # - name: Login to Docker Hub
      #   run: |
      #     echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login docker.io \
      #       -u "${{ secrets.DOCKERHUB_USERNAME }}" \
      #       --password-stdin

      - name: Create & push bun manifest
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          exponential_backoff: true
          command: |
            IMAGE="$REGISTRY/$IMAGE_OWNER/bun-app"

            podman manifest create "$IMAGE:latest" || true

            podman manifest add "$IMAGE:latest" "docker://$IMAGE:amd64"
            podman manifest add "$IMAGE:latest" "docker://$IMAGE:arm64"

            # Push to GHCR
            podman manifest push --all "$IMAGE:latest"

            # Optional: Push to Docker Hub
            # podman manifest push --all "$IMAGE:latest" \
            #   "docker://docker.io/${{ secrets.DOCKERHUB_USERNAME }}/bun-app:latest"

  # ---------- Node.js + npm ----------
  build-node:
    name: Build node image (${{ matrix.arch }})
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install podman-static for heredoc support
        run: |
          echo "=== Installing podman-static v5.6.2 ==="
          # Why podman-static?
          # - Containerfile uses RUN <<EOT heredoc syntax (requires buildah >= 1.35.0)
          # - Ubuntu 24.04 podman (4.9.3) uses buildah 1.33.7 (too old, no heredoc)

          # Download correct architecture binary
          ARCH="${{ matrix.arch }}"
          if [ "$ARCH" = "amd64" ]; then
            PODMAN_ARCH="amd64"
          else
            PODMAN_ARCH="arm64"
          fi

          curl -fsSL -o /tmp/podman-linux-${PODMAN_ARCH}.tar.gz \
            https://github.com/mgoltzsche/podman-static/releases/latest/download/podman-linux-${PODMAN_ARCH}.tar.gz
          cd /tmp && tar -xzf podman-linux-${PODMAN_ARCH}.tar.gz

          # Install binaries to /usr/bin (not /usr/local/bin) to avoid AppArmor issues
          # Ref: https://github.com/mgoltzsche/podman-static#apparmor-profile
          sudo cp -f podman-linux-${PODMAN_ARCH}/usr/local/bin/* /usr/bin/
          sudo cp -r podman-linux-${PODMAN_ARCH}/etc/* /etc/ 2>/dev/null || true

          # Initialize rootless podman
          podman system migrate

          echo "Podman installed to: $(which podman)"
          podman --version
          echo "Architecture: $(uname -m)"

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login "$REGISTRY" \
            -u "${{ github.actor }}" \
            --password-stdin

      # Optional: Login to Docker Hub
      # - name: Login to Docker Hub
      #   run: |
      #     echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login docker.io \
      #       -u "${{ secrets.DOCKERHUB_USERNAME }}" \
      #       --password-stdin

      - name: Build & push node image
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          exponential_backoff: true
          command: |
            IMAGE="$REGISTRY/$IMAGE_OWNER/node-app"
            TAG="${{ matrix.arch }}"

            # Production build (default, no shell)
            podman build \
              --format docker \
              --ulimit nofile=65536:65536 \
              -f Containerfile.nodejs \
              -t "$IMAGE:$TAG" .

            # Optional: Build debug version with shell
            # podman build \
            #   --build-arg RUNTIME_TAG=latest-dev \
            #   --format docker \
            #   -f Containerfile.nodejs \
            #   -t "$IMAGE:$TAG-debug" .

            # Push to GHCR
            podman push "$IMAGE:$TAG"
            # podman push "$IMAGE:$TAG-debug"

            # Optional: Push to Docker Hub
            # podman push "docker://docker.io/${{ secrets.DOCKERHUB_USERNAME }}/node-app:$TAG"

  manifest-node:
    name: Create node multi-arch manifest
    needs: build-node
    runs-on: ubuntu-24.04
    steps:
      - name: Install podman-static for heredoc support
        run: |
          echo "=== Installing podman-static v5.6.2 ==="
          # Why podman-static?
          # - Containerfile uses RUN <<EOT heredoc syntax (requires buildah >= 1.35.0)
          # - Ubuntu 24.04 podman (4.9.3) uses buildah 1.33.7 (too old, no heredoc)

          # Download correct architecture binary
          ARCH="${{ matrix.arch }}"
          if [ "$ARCH" = "amd64" ]; then
            PODMAN_ARCH="amd64"
          else
            PODMAN_ARCH="arm64"
          fi

          curl -fsSL -o /tmp/podman-linux-${PODMAN_ARCH}.tar.gz \
            https://github.com/mgoltzsche/podman-static/releases/latest/download/podman-linux-${PODMAN_ARCH}.tar.gz
          cd /tmp && tar -xzf podman-linux-${PODMAN_ARCH}.tar.gz

          # Install binaries to /usr/bin (not /usr/local/bin) to avoid AppArmor issues
          # Ref: https://github.com/mgoltzsche/podman-static#apparmor-profile
          sudo cp -f podman-linux-${PODMAN_ARCH}/usr/local/bin/* /usr/bin/
          sudo cp -r podman-linux-${PODMAN_ARCH}/etc/* /etc/ 2>/dev/null || true

          # Initialize rootless podman
          podman system migrate

          echo "Podman installed to: $(which podman)"
          podman --version
          echo "Architecture: $(uname -m)"

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login "$REGISTRY" \
            -u "${{ github.actor }}" \
            --password-stdin

      # Optional: Login to Docker Hub
      # - name: Login to Docker Hub
      #   run: |
      #     echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login docker.io \
      #       -u "${{ secrets.DOCKERHUB_USERNAME }}" \
      #       --password-stdin

      - name: Create & push node manifest
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          exponential_backoff: true
          command: |
            IMAGE="$REGISTRY/$IMAGE_OWNER/node-app"

            podman manifest create "$IMAGE:latest" || true

            podman manifest add "$IMAGE:latest" "docker://$IMAGE:amd64"
            podman manifest add "$IMAGE:latest" "docker://$IMAGE:arm64"

            # Push to GHCR
            podman manifest push --all "$IMAGE:latest"

            # Optional: Push to Docker Hub
            # podman manifest push --all "$IMAGE:latest" \
            #   "docker://docker.io/${{ secrets.DOCKERHUB_USERNAME }}/node-app:latest"
